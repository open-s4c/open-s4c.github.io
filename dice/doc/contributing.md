# Dice Contributing Checklist

Follow this list before opening a pull request so reviewers can focus on the
substance of your change set.

## Coding Style

- Run `clang-format -i` on modified C/C++ files; the repository ships a
  `.clang-format` that enforces 4-space indentation and 80-column lines
  (version >= 17).
- Run `cmake-format -i` on modified CMakeLists.txt files (version >= 0.6).
- Prefer `lower_snake_case` identifiers; exported symbols should use the
  `dice_`, `ps_`, or module-specific prefixes for consistency.
- Keep public headers minimal—add new APIs beside related source files and
  document them inline.
- Static or always-hidden helpers should end with an underscore (e.g.,
  `init_cache_`) to match existing naming conventions.

## Build and Test

```sh
cmake -B build
cmake --build build
ctest --test-dir build
```

Bug fixes should ensure the existing tests pass. In the best case, a new test
case is added under `test/`, which fails without the fix.  New functionality
should be added as additional modules in `src/mod` and a new focused test under
`test/` is mandatory.

## Documentation

- Update `doc/design.md` or `doc/api.md` when you change
  behaviour or add new APIs. Inline comments in `include/dice/*.h` should
  always reflect the current contract.
- Mention the commands you ran in the PR body (e.g., build, tests, benchmarks)
  as per the project guidelines.
- Generated sources live in the build tree. `.in` templates (for example,
  `dispatch.c.in`, `tsan_test.c.in`) are expanded by the in-tree `tmplr`
  executable ([link](https://github.com/open-s4c/tmplr)) during the CMake build,
  and helper targets such as `expand-dispatch` or `expand-tests` recreate the
  outputs under `build/`. Avoid committing the generated files themselves.

## Adding New Interceptors

- Ensure the implementation works on Linux with both glibc and musl, on NetBSD,
  and on macOS.
- When interposing symbols, include `dice/interpose.h` and use the `INTERPOSE`
  and `REAL` helpers—see `src/mod/malloc.c` for a reference pattern.
- Declare new event identifiers as `#define EVENT_<NAME> <number>` values in
  the appropriate header under `include/dice/events/`; avoid extending enums.
- Use `scripts/list_events` to enumerate existing event IDs and select an
  unused value less than `MAX_TYPES`.
- Event names follow the `EVENT_<DOMAIN>_<ACTION>` pattern used throughout
  `include/dice/events/` (for example, `EVENT_MUTEX_LOCK`, `EVENT_MALLOC`).
- Extend the autogenerated interposition tests by adding the function
  signature to `test/interpose/interposed.h.in` so the generator can craft the
  right expectations. The template uses `MM_RETURN_<name>`/`MM_PARAMS_<name>`
  macros—mirror the style of existing entries.
